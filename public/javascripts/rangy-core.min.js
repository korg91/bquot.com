/*
 Rangy, a cross-browser JavaScript range and selection library
 http://code.google.com/p/rangy/

 Copyright 2011, Tim Down
 Licensed under the MIT license.
 Version: 1.1.2
 Build date: 30 May 2011
*/
var rangy=function(){function e(b,c){var j=typeof b[c];return j==f||!!(j==x&&b[c])||j=="unknown"}function u(b,c){return!!(typeof b[c]==x&&b[c])}function q(b,c){return typeof b[c]!=d}function k(b){return function(c,j){for(var f=j.length;f--;)if(!b(c,j[f]))return!1;return!0}}function n(b){window.alert("Rangy not supported in your browser. Reason: "+b);j.initialized=!0;j.supported=!1}function p(){if(!j.initialized){var c,f=!1,d=!1;e(document,"createRange")&&(c=document.createRange(),w(c,m)&&b(c,F)&&
(f=!0),c.detach());if((c=u(document,"body")?document.body:document.getElementsByTagName("body")[0])&&e(c,"createTextRange"))c=c.createTextRange(),w(c,i)&&b(c,l)&&(d=!0);!f&&!d&&n("Neither Range nor TextRange are implemented");j.initialized=!0;j.features={implementsDomRange:f,implementsTextRange:d};f=z.concat(A);d=0;for(c=f.length;d<c;++d)try{f[d](j)}catch(o){u(window,"console")&&e(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",o)}}}function r(b){this.name=
b;this.supported=this.initialized=!1}var x="object",f="function",d="undefined",F=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],m=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],
l=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],i=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint"],w=k(e),c=k(u),b=k(q),j={initialized:!1,supported:!0,util:{isHostMethod:e,isHostObject:u,isHostProperty:q,areHostMethods:w,areHostObjects:c,areHostProperties:b},features:{},modules:{},config:{alertOnWarn:!1}};j.fail=n;j.warn=function(b){b="Rangy warning: "+b;j.config.alertOnWarn?
window.alert(b):typeof window.console!=d&&typeof window.console.log!=d&&window.console.log(b)};var A=[],z=[];j.init=p;j.addInitListener=function(b){j.initialized?b(j):A.push(b)};var o=[];j.addCreateMissingNativeApiListener=function(b){o.push(b)};j.createMissingNativeApi=function(b){b=b||window;p();for(var c=0,j=o.length;c<j;++c)o[c](b)};r.prototype.fail=function(b){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+b);};r.prototype.warn=function(b){j.warn("Module "+
this.name+": "+b)};r.prototype.createError=function(b){return Error("Error in Rangy "+this.name+" module: "+b)};j.createModule=function(b,c){var f=new r(b);j.modules[b]=f;z.push(function(b){c(b,f);f.initialized=!0;f.supported=!0})};j.requireModules=function(b){for(var c=0,f=b.length,d,e;c<f;++c){e=b[c];d=j.modules[e];if(!d||!(d instanceof r))throw Error("Module '"+e+"' not found");if(!d.supported)throw Error("Module '"+e+"' not supported");}};var y=!1,c=function(){y||(y=!0,j.initialized||p())};if(typeof window==
d)n("No window found");else if(typeof document==d)n("No document found");else return e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",c,!1),e(window,"addEventListener")?window.addEventListener("load",c,!1):e(window,"attachEvent")?window.attachEvent("onload",c):n("Window does not have required addEventListener or attachEvent method"),j}();
rangy.createModule("DomUtil",function(e,u){function q(b){for(var c=0;b=b.previousSibling;)c++;return c}function k(b,j){var f=[],d;for(d=b;d;d=d.parentNode)f.push(d);for(d=j;d;d=d.parentNode)if(c(f,d))return d;return null}function n(b,c,d){for(d=d?b:b.parentNode;d;){b=d.parentNode;if(b===c)return d;d=b}return null}function p(b){b=b.nodeType;return b==3||b==4||b==8}function r(b,c){var d=c.nextSibling,f=c.parentNode;d?f.insertBefore(b,d):f.appendChild(b);return b}function x(b){if(b.nodeType==9)return b;
else if(typeof b.ownerDocument!=l)return b.ownerDocument;else if(typeof b.document!=l)return b.document;else if(b.parentNode)return x(b.parentNode);else throw Error("getDocument: no document found for node");}function f(b){if(!b)return"[No node]";return p(b)?'"'+b.data+'"':b.nodeType==1?"<"+b.nodeName+(b.id?' id="'+b.id+'"':"")+">["+b.childNodes.length+"]":b.nodeName}function d(b){this._next=this.root=b}function F(b,c){this.node=b;this.offset=c}function m(b){this.code=this[b];this.codeName=b;this.message=
"DOMException: "+this.codeName}var l="undefined",i=e.util;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||u.fail("document missing a Node creation method");i.isHostMethod(document,"getElementsByTagName")||u.fail("document missing getElementsByTagName method");var w=document.createElement("div");i.areHostMethods(w,["insertBefore","appendChild","cloneNode"])||u.fail("Incomplete Element implementation");w=document.createTextNode("test");i.areHostMethods(w,["splitText",
"deleteData","insertData","appendData","cloneNode"])||u.fail("Incomplete Text Node implementation");var c=function(b,c){for(var d=b.length;d--;)if(b[d]===c)return!0;return!1};d.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var b=this._current=this._next,c;if(this._current){c=b.firstChild;if(!c)for(c=null;b!==this.root&&!(c=b.nextSibling);)b=b.parentNode;this._next=c}return this._current},detach:function(){this._current=this._next=this.root=null}};F.prototype={equals:function(b){return this.node===
b.node&this.offset==b.offset},inspect:function(){return"[DomPosition("+f(this.node)+":"+this.offset+")]"}};m.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};m.prototype.toString=function(){return this.message};e.dom={arrayContains:c,getNodeIndex:q,getCommonAncestor:k,isAncestorOf:function(b,c,d){for(c=d?c:c.parentNode;c;)if(c===b)return!0;else c=c.parentNode;return!1},getClosestAncestorIn:n,
isCharacterDataNode:p,insertAfter:r,splitDataNode:function(b,c){var d;b.nodeType==3?d=b.splitText(c):(d=b.cloneNode(),d.deleteData(0,c),b.deleteData(0,b.length-c),r(d,b));return d},getDocument:x,getWindow:function(b){b=x(b);if(typeof b.defaultView!=l)return b.defaultView;else if(typeof b.parentWindow!=l)return b.parentWindow;else throw Error("Cannot get a window object for node");},getIframeWindow:function(b){if(typeof b.contentWindow!=l)return b.contentWindow;else if(typeof b.contentDocument!=l)return b.contentDocument.defaultView;
else throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(b){if(typeof b.contentDocument!=l)return b.contentDocument;else if(typeof b.contentWindow!=l)return b.contentWindow.document;else throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(b){return i.isHostObject(b,"body")?b.body:b.getElementsByTagName("body")[0]},comparePoints:function(b,c,d,f){var e;if(b==d)return c===f?0:c<f?-1:1;else if(e=n(d,b,!0))return c<=
q(e)?-1:1;else if(e=n(b,d,!0))return q(e)<f?-1:1;else if(c=k(b,d),b=b===c?c:n(b,c,!0),d=d===c?c:n(d,c,!0),b===d)throw Error("comparePoints got to case 4 and childA and childB are the same!");else{for(c=c.firstChild;c;){if(c===b)return-1;else if(c===d)return 1;c=c.nextSibling}throw Error("Should not be here!");}},inspectNode:f,createIterator:function(b){return new d(b)},DomPosition:F};e.DOMException=m});
rangy.createModule("DomRange",function(e){function u(a,b){return a.nodeType!=3&&(g.isAncestorOf(a,b.startContainer,!0)||g.isAncestorOf(a,b.endContainer,!0))}function q(a){return g.getDocument(a.startContainer)}function k(a,b,c){if(b=a._listeners[b])for(var h=0,d=b.length;h<d;++h)b[h].call(a,{target:a,args:c})}function n(a){return new G(a.parentNode,g.getNodeIndex(a))}function p(a){return new G(a.parentNode,g.getNodeIndex(a)+1)}function r(a){return g.isCharacterDataNode(a)?a.length:a.childNodes?a.childNodes.length:
0}function x(a,b,c){var h=a.nodeType==11?a.firstChild:a;g.isCharacterDataNode(b)?c==b.length?g.insertAfter(a,b):b.parentNode.insertBefore(a,c==0?b:g.splitDataNode(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]);return h}function f(a){for(var b,c,h=q(a.range).createDocumentFragment();c=a.next();){b=a.isPartiallySelectedSubtree();c=c.cloneNode(!b);b&&(b=a.getSubtreeIterator(),c.appendChild(f(b)),b.detach(!0));if(c.nodeType==10)throw new B("HIERARCHY_REQUEST_ERR");h.appendChild(c)}return h}
function d(a,b,c){for(var h,f,c=c||{stop:!1};h=a.next();)if(a.isPartiallySelectedSubtree())if(b(h)===!1){c.stop=!0;break}else{if(h=a.getSubtreeIterator(),d(h,b,c),h.detach(!0),c.stop)break}else for(h=g.createIterator(h);f=h.next();)if(b(f)===!1){c.stop=!0;return}}function F(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),F(b),b.detach(!0)):a.remove()}function m(a){for(var b,c=q(a.range).createDocumentFragment(),h;b=a.next();){a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),
h=a.getSubtreeIterator(),b.appendChild(m(h)),h.detach(!0)):a.remove();if(b.nodeType==10)throw new B("HIERARCHY_REQUEST_ERR");c.appendChild(b)}return c}function l(a,b,c){var h=!(!b||!b.length),f,D=!!c;h&&(f=RegExp("^("+b.join("|")+")$"));var e=[];d(new w(a,!1),function(a){(!h||f.test(a.nodeType))&&(!D||c(a))&&e.push(a)});return e}function i(a){return"["+(typeof a.getName=="undefined"?"Range":a.getName())+"("+g.inspectNode(a.startContainer)+":"+a.startOffset+", "+g.inspectNode(a.endContainer)+":"+a.endOffset+
")]"}function w(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;this.sc=a.startContainer;this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&g.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===c&&!g.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:g.getClosestAncestorIn(this.sc,c,!0),this._last=this.ec===c&&!g.isCharacterDataNode(this.ec)?
this.ec.childNodes[this.eo-1]:g.getClosestAncestorIn(this.ec,c,!0))}function c(a){this.code=this[a];this.codeName=a;this.message="RangeException: "+this.codeName}function b(a,b,c){this.nodes=l(a,b,c);this._next=this.nodes[0];this._position=0}function j(a){return function(b,c){for(var h,d=c?b:b.parentNode;d;){h=d.nodeType;if(g.arrayContains(a,h))return d;d=d.parentNode}return null}}function A(a){for(var b;b=a.parentNode;)a=b;return a}function z(a,b){if(P(a,b))throw new c("INVALID_NODE_TYPE_ERR");}
function o(a){if(!a.startContainer)throw new B("INVALID_STATE_ERR");}function y(a,b){if(!g.arrayContains(b,a.nodeType))throw new c("INVALID_NODE_TYPE_ERR");}function H(a,b){if(b<0||b>(g.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new B("INDEX_SIZE_ERR");}function v(a,b){if(h(a,!0)!==h(b,!0))throw new B("WRONG_DOCUMENT_ERR");}function C(a){if(D(a,!0))throw new B("NO_MODIFICATION_ALLOWED_ERR");}function I(a,b){if(!a)throw new B(b);}function s(a){if(!h(a.startContainer,!0)||!h(a.endContainer,
!0)||!(a.startOffset<=(g.isCharacterDataNode(a.startContainer)?a.startContainer.length:a.startContainer.childNodes.length))||!(a.endOffset<=(g.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");}function E(a){a.START_TO_START=R;a.START_TO_END=U;a.END_TO_END=Z;a.END_TO_START=V;a.NODE_BEFORE=W;a.NODE_AFTER=X;a.NODE_BEFORE_AND_AFTER=Y;a.NODE_INSIDE=S}function L(a){E(a);
E(a.prototype)}function O(h,e,D){function j(a,b){return function(c){o(this);y(c,J);y(A(c),Q);c=(a?n:p)(c);(b?P:k)(this,c.node,c.offset)}}function P(a,b,c){var h=a.endContainer,d=a.endOffset;if(b!==a.startContainer||c!==this.startOffset){if(A(b)!=A(h)||g.comparePoints(b,c,h,d)==1)h=b,d=c;e(a,b,c,h,d)}}function k(a,b,c){var h=a.startContainer,d=a.startOffset;if(b!==a.endContainer||c!==this.endOffset){if(A(b)!=A(h)||g.comparePoints(b,c,h,d)==-1)h=b,d=c;e(a,h,d,b,c)}}function E(a,b,c){(b!==a.startContainer||
c!==this.startOffset||b!==a.endContainer||c!==this.endOffset)&&e(a,b,c,b,c)}function G(a){return function(){o(this);s(this);var b=this.startContainer,c=this.startOffset,h=this.commonAncestorContainer,f=new w(this,!0);if(b!==h)b=g.getClosestAncestorIn(b,h,!0),c=p(b),b=c.node,c=c.offset;d(f,C);f.reset();h=a(f);f.detach();e(this,b,c,b,c);return h}}h.prototype={attachListener:function(a,b){this._listeners[a].push(b)},setStart:function(a,b){o(this);z(a,!0);H(a,b);P(this,a,b)},setEnd:function(a,b){o(this);
z(a,!0);H(a,b);k(this,a,b)},setStartBefore:j(!0,!0),setStartAfter:j(!1,!0),setEndBefore:j(!0,!1),setEndAfter:j(!1,!1),collapse:function(a){o(this);s(this);a?e(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):e(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){o(this);z(a,!0);e(this,a,0,a,r(a))},selectNode:function(a){o(this);z(a,!1);y(a,J);var b=n(a),a=p(a);e(this,b.node,b.offset,a.node,a.offset)},compareBoundaryPoints:function(a,
b){o(this);s(this);v(this.startContainer,b.startContainer);var c=a==V||a==R?"start":"end",h=a==U||a==R?"start":"end";return g.comparePoints(this[c+"Container"],this[c+"Offset"],b[h+"Container"],b[h+"Offset"])},insertNode:function(a){o(this);s(this);y(a,K);C(this.startContainer);if(g.isAncestorOf(a,this.startContainer,!0))throw new B("HIERARCHY_REQUEST_ERR");this.setStartBefore(x(a,this.startContainer,this.startOffset))},cloneContents:function(){o(this);s(this);var a,b;if(this.collapsed)return q(this).createDocumentFragment();
else{if(this.startContainer===this.endContainer&&g.isCharacterDataNode(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=q(this).createDocumentFragment(),b.appendChild(a),b;else b=new w(this,!0),a=f(b),b.detach();return a}},extractContents:G(m),deleteContents:G(F),canSurroundContents:function(){o(this);s(this);C(this.startContainer);C(this.endContainer);var a=new w(this,!0),b=a._first&&u(a._first,this)||a._last&&u(a._last,this);
a.detach();return!b},surroundContents:function(b){y(b,a);if(!this.canSurroundContents())throw new c("BAD_BOUNDARYPOINTS_ERR");var h=this.extractContents();if(b.hasChildNodes())for(;b.lastChild;)b.removeChild(b.lastChild);x(b,this.startContainer,this.startOffset);b.appendChild(h);this.selectNode(b)},cloneRange:function(){o(this);s(this);for(var a=new t(q(this)),b=T.length,c;b--;)c=T[b],a[c]=this[c];return a},detach:function(){D(this)},toString:function(){o(this);s(this);var a=this.startContainer;if(a===
this.endContainer&&g.isCharacterDataNode(a))return a.nodeType==3||a.nodeType==4?a.data.slice(this.startOffset,this.endOffset):"";else{var b=[],a=new w(this,!0);d(a,function(a){(a.nodeType==3||a.nodeType==4)&&b.push(a.data)});a.detach();return b.join("")}},compareNode:function(a){o(this);s(this);var b=a.parentNode,c=g.getNodeIndex(a);if(!b)throw new B("NOT_FOUND_ERR");a=this.comparePoint(b,c);b=this.comparePoint(b,c+1);return a<0?b>0?Y:W:b>0?X:S},comparePoint:function(a,b){o(this);s(this);I(a,"HIERARCHY_REQUEST_ERR");
v(a,this.startContainer);if(g.comparePoints(a,b,this.startContainer,this.startOffset)<0)return-1;else if(g.comparePoints(a,b,this.endContainer,this.endOffset)>0)return 1;return 0},createContextualFragment:function(a){o(this);var b=q(this),c=b.createElement("div");c.innerHTML=a;for(a=b.createDocumentFragment();b=c.firstChild;)a.appendChild(b);return a},intersectsNode:function(a,b){o(this);s(this);I(a,"NOT_FOUND_ERR");if(g.getDocument(a)!==q(this))return!1;var c=a.parentNode,h=g.getNodeIndex(a);I(c,
"NOT_FOUND_ERR");var d=g.comparePoints(c,h,this.endContainer,this.endOffset),c=g.comparePoints(c,h+1,this.startContainer,this.startOffset);return b?d<=0&&c>=0:d<0&&c>0},isPointInRange:function(a,b){o(this);s(this);I(a,"HIERARCHY_REQUEST_ERR");v(a,this.startContainer);return g.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&g.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){o(this);s(this);if(q(a)!=q(this))throw new B("WRONG_DOCUMENT_ERR");return g.comparePoints(this.startContainer,
this.startOffset,a.endContainer,a.endOffset)<0&&g.comparePoints(this.endContainer,this.endOffset,a.startContainer,a.startOffset)>0},intersection:function(a){if(this.intersectsRange(a)){var b=g.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=g.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),h=this.cloneRange();b==-1&&h.setStart(a.startContainer,a.startOffset);c==1&&h.setEnd(a.endContainer,a.endOffset);return h}return null},containsNode:function(a,
b){return b?this.intersectsNode(a,!1):this.compareNode(a)==S},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,r(a))<=0},splitBoundaries:function(){s(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,h=this.endOffset,d=a===c;g.isCharacterDataNode(c)&&h>0&&h<c.length&&g.splitDataNode(c,h);g.isCharacterDataNode(a)&&b>0&&b<a.length&&(a=g.splitDataNode(a,b),d?(h-=b,c=a):c==a.parentNode&&h>=g.getNodeIndex(a)&&h++,b=0);e(this,a,b,c,h)},normalizeBoundaries:function(){s(this);
var a=this.startContainer,b=this.startOffset,c=this.endContainer,h=this.endOffset,d=function(a){var b=a.nextSibling;if(b&&b.nodeType==a.nodeType)c=a,h=a.length,a.appendData(b.data),b.parentNode.removeChild(b)},f=function(d){var f=d.previousSibling;if(f&&f.nodeType==d.nodeType){a=d;var e=d.length;b=f.length;d.insertData(0,f.data);f.parentNode.removeChild(f);a==c?(h+=b,c=a):c==d.parentNode&&(f=g.getNodeIndex(d),h==f?(c=d,h=e):h>f&&h--)}},D=!0;g.isCharacterDataNode(c)?c.length==h&&d(c):(h>0&&(D=c.childNodes[h-
1])&&g.isCharacterDataNode(D)&&d(D),D=!this.collapsed);D?g.isCharacterDataNode(a)?b==0&&f(a):b<a.childNodes.length&&(d=a.childNodes[b])&&g.isCharacterDataNode(d)&&f(d):(a=c,b=h);e(this,a,b,c,h)},createNodeIterator:function(a,c){o(this);s(this);return new b(this,a,c)},getNodes:function(a,b){o(this);s(this);return l(this,a,b)},collapseToPoint:function(a,b){o(this);s(this);z(a,!0);H(a,b);E(this,a,b)},collapseBefore:function(a){o(this);this.setEndBefore(a);this.collapse(!1)},collapseAfter:function(a){o(this);
this.setStartAfter(a);this.collapse(!0)},getName:function(){return"DomRange"},equals:function(a){return t.rangesEqual(this,a)},inspect:function(){return i(this)}};L(h)}function M(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:g.getCommonAncestor(a.startContainer,a.endContainer)}function N(a,b,c,h,d){var f=a.startContainer!==b||a.startOffset!==c,e=a.endContainer!==h||a.endOffset!==d;a.startContainer=b;a.startOffset=
c;a.endContainer=h;a.endOffset=d;M(a);k(a,"boundarychange",{startMoved:f,endMoved:e})}function t(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};M(this)}e.requireModules(["DomUtil"]);var g=e.dom,G=g.DomPosition,B=e.DOMException;w.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=
this._current=this._next;if(a)this._next=a!==this._last?a.nextSibling:null,g.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so));return a},remove:function(){var a=this._current,b,c;g.isCharacterDataNode(a)&&(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,c=a===this.ec?this.eo:a.length,b!=c&&a.deleteData(b,c-b)):a.parentNode&&a.parentNode.removeChild(a)},
isPartiallySelectedSubtree:function(){return u(this._current,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse();else{a=new t(q(this.range));var b=this._current,c=b,h=0,d=b,f=r(b);if(g.isAncestorOf(b,this.sc,!0))c=this.sc,h=this.so;if(g.isAncestorOf(b,this.ec,!0))d=this.ec,f=this.eo;N(a,c,h,d,f)}return new w(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach();this.range=this._current=this._next=this._first=
this._last=this.sc=this.so=this.ec=this.eo=null}};c.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};c.prototype.toString=function(){return this.message};b.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},detach:function(){this._current=this._next=this.nodes=null}};var J=[1,3,4,5,7,8,10],Q=[2,9,11],K=[1,3,4,5,7,8,10,11],a=[1,3,4,5,7,8],h=j([9,11]),D=j([5,6,10,12]),P=j([6,
10,12]),T=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],R=0,U=1,Z=2,V=3,W=0,X=1,Y=2,S=3;O(t,N,function(a){o(a);a.startContainer=a.startOffset=a.endContainer=a.endOffset=null;a.collapsed=a.commonAncestorContainer=null;k(a,"detach",null);a._listeners=null});t.fromRange=function(a){var b=new t(q(a));N(b,a.startContainer,a.startOffset,a.endContainer,a.endOffset);return b};t.rangeProperties=T;t.RangeIterator=w;t.copyComparisonConstants=L;t.createPrototypeRange=
O;t.inspect=i;t.getRangeDocument=q;t.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset};t.getEndOffset=r;e.DomRange=t;e.RangeException=c});
rangy.createModule("WrappedRange",function(e){function u(f,d,e,m){var l=f.duplicate();l.collapse(e);var i=l.parentElement();n.isAncestorOf(d,i,!0)||(i=d);if(!i.canHaveHTML)return new p(i.parentNode,n.getNodeIndex(i));var d=n.getDocument(i).createElement("span"),k,c=e?"StartToStart":"StartToEnd";do i.insertBefore(d,d.previousSibling),l.moveToElementText(d);while((k=l.compareEndPoints(c,f))>0&&d.previousSibling);c=d.nextSibling;if(k==-1&&c&&n.isCharacterDataNode(c)){l.setEndPoint(e?"EndToStart":"EndToEnd",
f);if(/[\r\n]/.test(c.data)){i=l.duplicate();e=i.text.replace(/\r\n/g,"\r").length;for(e=i.moveStart("character",e);i.compareEndPoints("StartToEnd",i)==-1;)e++,i.moveStart("character",1)}else e=l.text.length;i=new p(c,e)}else c=(m||!e)&&d.previousSibling,i=(e=(m||e)&&d.nextSibling)&&n.isCharacterDataNode(e)?new p(e,0):c&&n.isCharacterDataNode(c)?new p(c,c.length):new p(i,n.getNodeIndex(d));d.parentNode.removeChild(d);return i}function q(f,d){var e,m,l=f.offset,i=n.getDocument(f.node),k=i.body.createTextRange(),
c=n.isCharacterDataNode(f.node);c?(e=f.node,m=e.parentNode):(e=f.node.childNodes,e=l<e.length?e[l]:null,m=f.node);i=i.createElement("span");i.innerHTML="&#feff;";e?m.insertBefore(i,e):m.appendChild(i);k.moveToElementText(i);k.collapse(!d);m.removeChild(i);if(c)k[d?"moveStart":"moveEnd"]("character",l);return k}e.requireModules(["DomUtil","DomRange"]);var k,n=e.dom,p=n.DomPosition,r=e.DomRange;if(e.features.implementsDomRange)(function(){function f(c){for(var b=e.length,d;b--;)d=e[b],c[d]=c.nativeRange[d]}
var d,e=r.rangeProperties,m;k=function(c){if(!c)throw Error("Range must be specified");this.nativeRange=c;f(this)};r.createPrototypeRange(k,function(c,b,d,f,e){var i=c.endContainer!==f||c.endOffset!=e;if(c.startContainer!==b||c.startOffset!=d||i)c.setEnd(f,e),c.setStart(b,d)},function(c){c.nativeRange.detach();c.detached=!0;for(var b=e.length,d;b--;)d=e[b],c[d]=null});d=k.prototype;d.selectNode=function(c){this.nativeRange.selectNode(c);f(this)};d.deleteContents=function(){this.nativeRange.deleteContents();
f(this)};d.extractContents=function(){var c=this.nativeRange.extractContents();f(this);return c};d.cloneContents=function(){return this.nativeRange.cloneContents()};d.surroundContents=function(c){this.nativeRange.surroundContents(c);f(this)};d.collapse=function(c){this.nativeRange.collapse(c);f(this)};d.cloneRange=function(){return new k(this.nativeRange.cloneRange())};d.refresh=function(){f(this)};d.toString=function(){return this.nativeRange.toString()};var l=document.createTextNode("test");n.getBody(document).appendChild(l);
var i=document.createRange();i.setStart(l,0);i.setEnd(l,0);try{i.setStart(l,1),d.setStart=function(c,b){var d=n.isCharacterDataNode(c)?c.length:c.childNodes.length;b>d&&(b=d);b<0&&(b=0);this.nativeRange.setStart(c,b);f(this)},d.setEnd=function(c,b){this.nativeRange.setEnd(c,b);f(this)},m=function(c){return function(b){this.nativeRange[c](b);f(this)}}}catch(p){d.setStart=function(c,b){var d=n.isCharacterDataNode(c)?c.length:c.childNodes.length;b>d&&(b=d);b<0&&(b=0);try{this.nativeRange.setStart(c,
b)}catch(e){this.nativeRange.setEnd(c,b),this.nativeRange.setStart(c,b)}f(this)},d.setEnd=function(c,b){var d=n.isCharacterDataNode(c)?c.length:c.childNodes.length;b>d&&(b=d);b<0&&(b=0);try{this.nativeRange.setEnd(c,b)}catch(e){this.nativeRange.setStart(c,b),this.nativeRange.setEnd(c,b)}f(this)},m=function(c,b){return function(d){try{this.nativeRange[c](d)}catch(e){this.nativeRange[b](d),this.nativeRange[c](d)}f(this)}}}d.setStartBefore=m("setStartBefore","setEndBefore");d.setStartAfter=m("setStartAfter",
"setEndAfter");d.setEndBefore=m("setEndBefore","setStartBefore");d.setEndAfter=m("setEndAfter","setStartAfter");i.selectNodeContents(l);d.selectNodeContents=i.startContainer==l&&i.endContainer==l&&i.startOffset==0&&i.endOffset==l.length?function(c){this.nativeRange.selectNodeContents(c);f(this)}:function(c){this.setStart(c,0);this.setEnd(c,r.getEndOffset(c))};i.selectNodeContents(l);i.setEnd(l,3);m=document.createRange();m.selectNodeContents(l);m.setEnd(l,4);m.setStart(l,2);d.compareBoundaryPoints=
i.compareBoundaryPoints(i.START_TO_END,m)==-1&i.compareBoundaryPoints(i.END_TO_START,m)==1?function(c,b){b=b.nativeRange||b;if(c==b.START_TO_END)c=b.END_TO_START;else if(c==b.END_TO_START)c=b.START_TO_END;return this.nativeRange.compareBoundaryPoints(c,b)}:function(c,b){return this.nativeRange.compareBoundaryPoints(c,b.nativeRange||b)};n.getBody(document).removeChild(l);i.detach();m.detach()})();else if(e.features.implementsTextRange){k=function(e){this.textRange=e;this.refresh()};k.prototype=new r(document);
k.prototype.refresh=function(){var e,d,k=this.textRange;e=k.parentElement();var m=k.duplicate();m.collapse(!0);d=m.parentElement();m=k.duplicate();m.collapse(!1);k=m.parentElement();d=d==k?d:n.getCommonAncestor(d,k);d=d==e?d:n.getCommonAncestor(e,d);this.textRange.compareEndPoints("StartToEnd",this.textRange)==0?d=e=u(this.textRange,d,!0,!0):(e=u(this.textRange,d,!0,!1),d=u(this.textRange,d,!1,!1));this.setStart(e.node,e.offset);this.setEnd(d.node,d.offset)};k.rangeToTextRange=function(e){if(e.collapsed)return q(new p(e.startContainer,
e.startOffset),!0);else{var d=q(new p(e.startContainer,e.startOffset),!0),k=q(new p(e.endContainer,e.endOffset),!1),e=n.getDocument(e.startContainer).body.createTextRange();e.setEndPoint("StartToStart",d);e.setEndPoint("EndToEnd",k);return e}};r.copyComparisonConstants(k);var x=function(){return this}();if(typeof x.Range=="undefined")x.Range=k}k.prototype.getName=function(){return"WrappedRange"};e.WrappedRange=k;e.createNativeRange=function(f){f=f||document;if(e.features.implementsDomRange)return f.createRange();
else if(e.features.implementsTextRange)return f.body.createTextRange()};e.createRange=function(f){return new k(e.createNativeRange(f||document))};e.createRangyRange=function(e){return new r(e||document)};e.createIframeRange=function(f){return e.createRange(n.getIframeDocument(f))};e.createIframeRangyRange=function(f){return e.createRangyRange(n.getIframeDocument(f))};e.addCreateMissingNativeApiListener(function(f){f=f.document;if(typeof f.createRange=="undefined")f.createRange=function(){return e.createRange(this)};
f=f=null})});
rangy.createModule("WrappedSelection",function(e,u){function q(a){return(a||window).getSelection()}function k(a){return(a||window).document.selection}function n(a,b,c){var d=c?"end":"start",c=c?"start":"end";a.anchorNode=b[d+"Container"];a.anchorOffset=b[d+"Offset"];a.focusNode=b[c+"Container"];a.focusOffset=b[c+"Offset"]}function p(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function r(a){var b;if(a instanceof j){if(b=a._selectionNativeRange,
!b)b=e.createNativeRange(c.getDocument(a.startContainer)),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset),a._selectionNativeRange=b,a.attachListener("detach",function(){this._selectionNativeRange=null})}else a instanceof A?b=a.nativeRange:window.Range&&a instanceof Range&&(b=a);return b}function x(a){var b=a.getNodes(),d;a:if(!b.length||b[0].nodeType!=1)d=!1;else{d=1;for(var e=b.length;d<e;++d)if(!c.isAncestorOf(b[0],b[d])){d=!1;break a}d=!0}if(!d)throw Error("getSingleElementFromRange: range "+
a.inspect()+" did not consist of a single element");return b[0]}function f(a,b){var c=new A(b);a._ranges=[c];n(a,c,!1);a.rangeCount=1;a.isCollapsed=c.collapsed}function d(a){a._ranges.length=0;if(a.docSelection.type=="None")p(a);else{var b=a.docSelection.createRange();if(b&&typeof b.text!="undefined")f(a,b);else{a.rangeCount=b.length;for(var d,g=c.getDocument(b.item(0)),i=0;i<a.rangeCount;++i)d=e.createRange(g),d.selectNode(b.item(i)),a._ranges.push(d);a.isCollapsed=a.rangeCount==1&&a._ranges[0].collapsed;
n(a,a._ranges[a.rangeCount-1],!1)}}}function F(a,b){for(var e=a.docSelection.createRange(),f=x(b),g=c.getDocument(e.item(0)),g=c.getBody(g).createControlRange(),i=0,j=e.length;i<j;++i)g.add(e.item(i));try{g.add(f)}catch(k){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}g.select();d(a)}function m(a,b,c){this.nativeSelection=a;this.docSelection=b;this._ranges=[];this.win=c;this.refresh()}function l(a,b){for(var e=c.getDocument(b[0].startContainer),
e=c.getBody(e).createControlRange(),f=0,g;f<rangeCount;++f){g=x(b[f]);try{e.add(g)}catch(i){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}e.select();d(a)}function i(a,b){if(a.anchorNode&&c.getDocument(a.anchorNode)!==c.getDocument(b))throw new z("WRONG_DOCUMENT_ERR");}function w(a){var b=[],c=new o(a.anchorNode,a.anchorOffset),d=new o(a.focusNode,a.focusOffset),e=typeof a.getName=="function"?a.getName():
"Selection";if(typeof a.rangeCount!="undefined")for(var f=0,g=a.rangeCount;f<g;++f)b[f]=j.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}e.requireModules(["DomUtil","DomRange","WrappedRange"]);e.config.checkSelectionRanges=!0;var c=e.dom,b=e.util,j=e.DomRange,A=e.WrappedRange,z=e.DOMException,o=c.DomPosition,y,H,v=e.util.isHostMethod(window,"getSelection"),C=e.util.isHostObject(document,"selection");v?(y=q,e.isSelectionValid=function(){return!0}):
C?(y=k,e.isSelectionValid=function(a){var a=(a||window).document,b=a.selection;return b.type!="None"||c.getDocument(b.createRange().parentElement())==a}):u.fail("No means of obtaining a selection object");e.getNativeSelection=y;var v=y(),I=e.createNativeRange(document),s=c.getBody(document),E=b.areHostObjects(v,b.areHostProperties(v,["anchorOffset","focusOffset"]));e.features.selectionHasAnchorAndFocus=E;var L=b.isHostMethod(v,"extend");e.features.selectionHasExtend=L;var O=typeof v.rangeCount=="number";
e.features.selectionHasRangeCount=O;var M=!1,N=!0;b.areHostMethods(v,["addRange","getRangeAt","removeAllRanges"])&&typeof v.rangeCount=="number"&&e.features.implementsDomRange&&function(){var a=document.createElement("iframe");s.appendChild(a);var b=c.getIframeDocument(a);b.open();b.write("<html><head></head><body>12</body></html>");b.close();var d=c.getIframeWindow(a).getSelection(),e=b.documentElement.lastChild.firstChild,b=b.createRange();b.setStart(e,1);b.collapse(!0);d.addRange(b);N=d.rangeCount==
1;d.removeAllRanges();var f=b.cloneRange();b.setStart(e,0);f.setEnd(e,2);d.addRange(b);d.addRange(f);M=d.rangeCount==2;b.detach();f.detach();s.removeChild(a)}();e.features.selectionSupportsMultipleRanges=M;e.features.collapsedNonEditableSelectionsSupported=N;var t=!1,g;s&&b.isHostMethod(s,"createControlRange")&&(g=s.createControlRange(),b.areHostProperties(g,["item","add"])&&(t=!0));e.features.implementsControlRange=t;H=E?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:
function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var G;b.isHostMethod(v,"getRangeAt")?G=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:E&&(G=function(a){var b=c.getDocument(a.anchorNode),b=e.createRange(b);b.setStart(a.anchorNode,a.anchorOffset);b.setEnd(a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&(b.setStart(a.focusNode,a.focusOffset),b.setEnd(a.anchorNode,a.anchorOffset));return b});e.getSelection=function(a){var a=a||window,b=a._rangySelection,
c=y(a),d=C?k(a):null;b?(b.nativeSelection=c,b.docSelection=d,b.refresh(a)):(b=new m(c,d,a),a._rangySelection=b);return b};e.getIframeSelection=function(a){return e.getSelection(c.getIframeWindow(a))};g=m.prototype;if(E&&b.areHostMethods(v,["removeAllRanges","addRange"])){g.removeAllRanges=function(){this.nativeSelection.removeAllRanges();p(this)};var B=function(a,b){var c=j.getRangeDocument(b),c=e.createRange(c);c.collapseToPoint(b.endContainer,b.endOffset);a.nativeSelection.addRange(r(c));a.nativeSelection.extend(b.startContainer,
b.startOffset);a.refresh()};g.addRange=O?function(a,b){if(t&&C&&this.docSelection.type=="Control")F(this,a);else if(b&&L)B(this,a);else{var c;M?c=this.rangeCount:(this.removeAllRanges(),c=0);this.nativeSelection.addRange(r(a));this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==c+1?(e.config.checkSelectionRanges&&(c=G(this.nativeSelection,this.rangeCount-1))&&!j.rangesEqual(c,a)&&(a=new A(c)),this._ranges[this.rangeCount-1]=a,n(this,a,K(this.nativeSelection)),this.isCollapsed=H(this)):
this.refresh()}}:function(a,b){b&&L?B(this,a):(this.nativeSelection.addRange(r(a)),this.refresh())};g.setRanges=function(a){if(t&&a.length>1)l(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;b<c;++b)this.addRange(a[b])}}}else if(b.isHostMethod(v,"empty")&&b.isHostMethod(I,"select")&&t&&C)g.removeAllRanges=function(){try{if(this.docSelection.empty(),this.docSelection.type!="None"){var a;if(this.anchorNode)a=c.getDocument(this.anchorNode);else if(this.docSelection.type=="Control"){var b=
this.docSelection.createRange();b.length&&(a=c.getDocument(b.item(0)).body.createTextRange())}a&&(a.body.createTextRange().select(),this.docSelection.empty())}}catch(d){}p(this)},g.addRange=function(a){this.docSelection.type=="Control"?F(this,a):(A.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,n(this,a,!1))},g.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?l(this,a):b&&this.addRange(a[0])};else return u.fail("No means of selecting a Range or TextRange was found"),
!1;g.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new z("INDEX_SIZE_ERR");else return this._ranges[a]};var J;if(b.isHostMethod(v,"getRangeAt")&&typeof v.rangeCount=="number")J=function(a){if(t&&C&&a.docSelection.type=="Control")d(a);else if(a._ranges.length=a.rangeCount=a.nativeSelection.rangeCount,a.rangeCount){for(var b=0,c=a.rangeCount;b<c;++b)a._ranges[b]=new e.WrappedRange(a.nativeSelection.getRangeAt(b));n(a,a._ranges[a.rangeCount-1],K(a.nativeSelection));a.isCollapsed=H(a)}else p(a)};
else if(E&&typeof v.isCollapsed=="boolean"&&typeof I.collapsed=="boolean"&&e.features.implementsDomRange)J=function(a){var b;b=a.nativeSelection;b.anchorNode?(b=G(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,a.isCollapsed=H(a)):p(a)};else if(b.isHostMethod(v,"createRange")&&C)J=function(a){var b;e.isSelectionValid(a.win)?b=a.docSelection.createRange():(b=c.getBody(a.win.document).createTextRange(),
b.collapse(!0));a.docSelection.type=="Control"?d(a):b&&typeof b.text!="undefined"?f(a,b):p(a)};else return u.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;g.refresh=function(a){var b=a?this._ranges.slice(0):null;J(this);if(a){a=b.length;if(a!=this._ranges.length)return!1;for(;a--;)if(!j.rangesEqual(b[a],this._ranges[a]))return!1;return!0}};var Q=function(a,b){var c=a.getAllRanges(),d=!1;a.removeAllRanges();for(var e=0,f=c.length;e<f;++e)d||b!==c[e]?a.addRange(c[e]):
d=!0;a.rangeCount||p(a)};g.removeRange=t?function(a){if(this.docSelection.type=="Control"){for(var b=this.docSelection.createRange(),a=x(a),e=c.getDocument(b.item(0)),e=c.getBody(e).createControlRange(),f,g=!1,i=0,j=b.length;i<j;++i)f=b.item(i),f!==a||g?e.add(b.item(i)):g=!0;e.select();d(this)}else Q(this,a)}:function(a){Q(this,a)};var K;E&&e.features.implementsDomRange?(K=function(a){var b=!1;a.anchorNode&&(b=c.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1);return b},g.isBackwards=
function(){return K(this)}):K=g.isBackwards=function(){return!1};g.toString=function(){for(var a=[],b=0,c=this.rangeCount;b<c;++b)a[b]=""+this._ranges[b];return a.join("")};g.collapse=function(a,b){i(this,a);var d=e.createRange(c.getDocument(a));d.collapseToPoint(a,b);this.removeAllRanges();this.addRange(d);this.isCollapsed=!0};g.collapseToStart=function(){if(this.rangeCount){var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new z("INVALID_STATE_ERR");};g.collapseToEnd=
function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new z("INVALID_STATE_ERR");};g.selectAllChildren=function(a){i(this,a);var b=e.createRange(c.getDocument(a));b.selectNodeContents(a);this.removeAllRanges();this.addRange(b)};g.deleteFromDocument=function(){if(t&&C&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount){a=
this.getAllRanges();this.removeAllRanges();b=0;for(var c=a.length;b<c;++b)a[b].deleteContents();this.addRange(a[c-1])}};g.getAllRanges=function(){return this._ranges.slice(0)};g.setSingleRange=function(a){this.setRanges([a])};g.containsNode=function(a,b){for(var c=0,d=this._ranges.length;c<d;++c)if(this._ranges[c].containsNode(a,b))return!0;return!1};g.getName=function(){return"WrappedSelection"};g.inspect=function(){return w(this)};g.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=
null};m.inspect=w;e.Selection=m;e.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=function(){return e.getSelection(this)};a=null})});